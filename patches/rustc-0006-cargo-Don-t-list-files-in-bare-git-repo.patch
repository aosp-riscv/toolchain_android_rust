From 1bbbe50cc4456f86e2415ecb806bca67294a637b Mon Sep 17 00:00:00 2001
From: Matthew Maurer <mmaurer@google.com>
Date: Fri, 7 Feb 2020 11:28:43 -0800
Subject: [PATCH] cargo: Don't list-files in bare git repo

Change-Id: I1f1a779a6a13f3a71e232e75acf834ddf1de02a3
---
 src/tools/cargo/src/cargo/sources/path.rs | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/tools/cargo/src/cargo/sources/path.rs b/src/tools/cargo/src/cargo/sources/path.rs
index db8e7d998..7e3d061f9 100644
--- a/src/tools/cargo/src/cargo/sources/path.rs
+++ b/src/tools/cargo/src/cargo/sources/path.rs
@@ -180,6 +180,13 @@ impl<'cfg> PathSource<'cfg> {
                     };
                     let path = root.strip_prefix(cur).unwrap().join("Cargo.toml");
                     if index.get_path(&path, 0).is_some() {
+                        // We're in the index, but with a bare repo, there's
+                        // not a canonical workdir, so list_files_git won't
+                        // work. Fall back to non-git-based source detection.
+                        // See rust-lang/cargo#7876.
+                        if repo.is_bare() {
+                            return None
+                        }
                         return Some(self.list_files_git(pkg, &repo, filter));
                     }
                 }
-- 
2.25.0.341.g760bfbb309-goog

