From 67e59c05eb2d907d5a8a1ccd5785939af78532f4 Mon Sep 17 00:00:00 2001
From: Jeff Vander Stoep <jeffv@google.com>
Date: Mon, 29 Mar 2021 12:23:47 +0200
Subject: [PATCH] Populate abort message

Change-Id: I36d84d95eededb2670fb9923ad9c848e8519d8e5
---
 library/panic_abort/Cargo.toml     |  1 +
 library/panic_abort/src/android.rs | 27 +++++++++++++++++++++++++++
 library/panic_abort/src/lib.rs     | 10 +++++++++-
 3 files changed, 37 insertions(+), 1 deletion(-)
 create mode 100644 library/panic_abort/src/android.rs

diff --git a/library/panic_abort/Cargo.toml b/library/panic_abort/Cargo.toml
index b15919fad7..94bd77b4d8 100644
--- a/library/panic_abort/Cargo.toml
+++ b/library/panic_abort/Cargo.toml
@@ -10,6 +10,7 @@ bench = false
 doc = false
 
 [dependencies]
+alloc = { path = "../alloc" }
 cfg-if = { version = "0.1.8", features = ['rustc-dep-of-std'] }
 core = { path = "../core" }
 libc = { version = "0.2", default-features = false }
diff --git a/library/panic_abort/src/android.rs b/library/panic_abort/src/android.rs
new file mode 100644
index 0000000000..f68bfda408
--- /dev/null
+++ b/library/panic_abort/src/android.rs
@@ -0,0 +1,27 @@
+#![feature(std_internals)]
+
+use alloc::string::String;
+use alloc::boxed::Box;
+use core::any::Any;
+use core::panic::BoxMeUp;
+
+#[rustc_std_internal_symbol]
+unsafe fn format_payload(payload: *mut &mut dyn BoxMeUp) -> String {
+    let payload = Box::from_raw((*payload).take_box());
+    let msg = match payload.downcast_ref::<&'static str>() {
+        Some(s) => String::from(*s),
+        None => match payload.downcast_ref::<String>() {
+            Some(s) => String::from(s),
+            None => String::from("<unsupported panic payload type>"),
+        },
+    };
+    return msg
+}
+
+pub(crate) unsafe fn android_set_abort_message(payload: *mut &mut dyn BoxMeUp) {
+        // std::ffi::CString is not available here. Use alloc::vec to create the char* argument.
+        // Manually append the final null byte.
+        let mut msg = format_payload(payload).into_bytes();
+        msg.push(0);
+        libc::android_set_abort_message(msg.as_ptr() as *const libc::c_char);
+}
diff --git a/library/panic_abort/src/lib.rs b/library/panic_abort/src/lib.rs
index eb2277d8ba..4b700cb86e 100644
--- a/library/panic_abort/src/lib.rs
+++ b/library/panic_abort/src/lib.rs
@@ -19,6 +19,9 @@
 #![feature(rustc_attrs)]
 #![feature(asm)]
 
+#[cfg(target_os = "android")]
+mod android;
+
 use core::any::Any;
 use core::panic::BoxMeUp;
 
@@ -28,9 +31,14 @@ pub unsafe extern "C" fn __rust_panic_cleanup(_: *mut u8) -> *mut (dyn Any + Sen
     unreachable!()
 }
 
-// "Leak" the payload and shim to the relevant abort on the platform in question.
+// Use the relevant abort on the platform in question.
 #[rustc_std_internal_symbol]
 pub unsafe extern "C" fn __rust_start_panic(_payload: *mut &mut dyn BoxMeUp) -> u32 {
+
+    // Android has the ability to attach a message as part of the abort.
+    #[cfg(target_os = "android")]
+    android::android_set_abort_message(_payload as *mut &mut dyn BoxMeUp);
+
     abort();
 
     cfg_if::cfg_if! {
-- 
2.31.0.291.g576ba9dcdaf-goog

