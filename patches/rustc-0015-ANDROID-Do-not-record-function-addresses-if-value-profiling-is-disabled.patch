From 58462019889b49b2e6eaf1e9e3cde298049d0186 Mon Sep 17 00:00:00 2001
From: Pirama Arumuga Nainar <pirama@google.com>
Date: Wed, 28 Jul 2021 17:47:50 -0700
Subject: [PATCH] Do not record function addresses if value profiling is
 disabled

Temporary change until a proper fix is merged to upstream.

Don't recording function addresses in __llvm_prf_data when value
profiling is turned off.  This is safe for Android, where we don't use
value profiling.

Functional change: needs -mllvm -enable-value-profiling to work with LTO

The proper fix is to use associated metadata to link a __llvm_prf_data
of a function with the function itself so the linker can discard the
__llvm_prf_data if the function itself is discarded.  See
http://lists.llvm.org/pipermail/llvm-dev/2019-December/137363.html for
more details.

Change-Id: Ied45bf573b095152f4ad90966b404cf47634ba90
---
 src/llvm-project/clang/lib/CodeGen/CodeGenPGO.cpp         | 5 +----
 .../lib/Transforms/Instrumentation/InstrProfiling.cpp     | 8 ++++++++
 2 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/src/llvm-project/clang/lib/CodeGen/CodeGenPGO.cpp b/src/llvm-project/clang/lib/CodeGen/CodeGenPGO.cpp
index 08ae877850..653b335db5 100644
--- a/src/llvm-project/clang/lib/CodeGen/CodeGenPGO.cpp
+++ b/src/llvm-project/clang/lib/CodeGen/CodeGenPGO.cpp
@@ -22,10 +22,7 @@
 #include "llvm/Support/FileSystem.h"
 #include "llvm/Support/MD5.h"
 
-static llvm::cl::opt<bool>
-    EnableValueProfiling("enable-value-profiling", llvm::cl::ZeroOrMore,
-                         llvm::cl::desc("Enable value profiling"),
-                         llvm::cl::Hidden, llvm::cl::init(false));
+extern llvm::cl::opt<bool> EnableValueProfiling;
 
 using namespace clang;
 using namespace CodeGen;
diff --git a/src/llvm-project/llvm/lib/Transforms/Instrumentation/InstrProfiling.cpp b/src/llvm-project/llvm/lib/Transforms/Instrumentation/InstrProfiling.cpp
index 9efc7d1ac5..c0c25dc9f1 100644
--- a/src/llvm-project/llvm/lib/Transforms/Instrumentation/InstrProfiling.cpp
+++ b/src/llvm-project/llvm/lib/Transforms/Instrumentation/InstrProfiling.cpp
@@ -57,6 +57,11 @@ using namespace llvm;
 
 #define DEBUG_TYPE "instrprof"
 
+llvm::cl::opt<bool>
+    EnableValueProfiling("enable-value-profiling", llvm::cl::ZeroOrMore,
+                         llvm::cl::desc("Enable value profiling"),
+                         llvm::cl::Hidden, llvm::cl::init(false));
+
 namespace {
 
 cl::opt<bool> DoHashBasedCounterSplit(
@@ -747,6 +752,9 @@ static std::string getVarName(InstrProfIncrementInst *Inc, StringRef Prefix) {
 }
 
 static inline bool shouldRecordFunctionAddr(Function *F) {
+  if (!EnableValueProfiling)
+    return false;
+
   // Check the linkage
   bool HasAvailableExternallyLinkage = F->hasAvailableExternallyLinkage();
   if (!F->hasLinkOnceLinkage() && !F->hasLocalLinkage() &&
-- 
2.32.0.554.ge1b32706d8-goog

